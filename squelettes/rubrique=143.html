<?php 
session_start();
?>


<BOUCLE_princ(RUBRIQUES){id_rubrique}>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>

<INCLURE{fond=inc_tur/agheader_chercher}{id_rubrique}>


<link href="agenda/css_1_inspip.css" rel="stylesheet" type="text/css" media="screen" />
<link href="agenda/css_calendrier_inspip.css" rel="stylesheet" type="text/css" media="screen" />
<link href="agenda/moteur_2_2/moteur_2.css" rel="stylesheet" type="text/css" media="screen" />
<link href="agenda/moteur_2_2/js/css/custom-theme/jquery-ui-1.7.2.custom.css" rel="stylesheet" type="text/css" media="screen" />

<!-- script src="agenda/moteur_2_2/js/js/jquery-1.3.2.min.js" type="text/javascript"></script -->
<script src="agenda/moteur_2_2/js/js/jquery-ui-1.7.2.custom.min.js" type="text/javascript"></script>


<script type="text/javascript">

//window.loadFirebugConsole();
$(document).ready(function (){
	
	/* +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
	Cette fonction est appelée par les "mouvements" du visiteur
	Elle va chercher les variables dans tous les champs du formulaire, 
	et les envoie au PHP qui va ensuite les tester (==0 ?)
	+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */
	function appel_php() {
		//console.debug("Fonction appel_php lancée") ;
		
		$('#nbre_resultats_id').fadeOut(100);
/*		$('#event_preview_id').fadeOut(800, function () {
		$('#event_preview_id').slideUp("slow");
		      });
*/

		$('#event_preview_id').fadeTo(100, 0.2);
		$('#event_preview_id').slideUp(200);
		
		
		
		// ---------------------------------------------
		// On récupère toutes les valeurs des champs
		// ---------------------------------------------
		
		
		// RAZ champ d'info
		$("#montrer_selection").html(""); 
		votre_selection = '';
		

		// Date Début
		selecteur_date_in = $("#selecteur_date_in").val();
		//console.debug("Date fin : "+selecteur_date_out) ;
		if(selecteur_date_in) {
			votre_selection+= "Date de début : "+selecteur_date_in+"<br />";
		}
		else {
			//votre_selection+= "Aucune date de début choisie<br />";
			selecteur_date_in = 'non_selct' ;
		}

		// Date fin
		selecteur_date_out = $("#selecteur_date_out").val();
		//console.debug("Date fin : "+selecteur_date_out) ;
		if(selecteur_date_out) {
			votre_selection+= "Date de fin : "+selecteur_date_out+"<br />";
		}
		else {
			//votre_selection+= "Aucune date de fin choisie<br />";
			selecteur_date_out = 'non_selct' ;
		}



		// LIEU
		valeur_lieu_recup = $("#selecteur_lieu").val();
		//console.debug("lieu : "+valeur_lieu_recup) ;
		if(valeur_lieu_recup!='non_selct') {
			nom_lieu_recup = $('#selecteur_genre :selected').text() ;
			votre_selection+= "Lieu : "+nom_lieu_recup+"<br />";
		}
		else {
			//votre_selection+= "Aucun lieu choisi<br />";
		}
		
	
		// REGION
		valeur_region_recup = $("#selecteur_region").val();
		//console.debug("Region : "+valeur_region_recup) ;
		if(valeur_region_recup!='non_selct') {
			nom_region_recup = $('#selecteur_region :selected').text() ;
			votre_selection+= "region : "+nom_region_recup+"<br />";
		}
		else {
			//votre_selection+= "Aucune region choisie<br />";
		}
		

		// GENRE
		valeur_genre_recup = $("#selecteur_genre").val();
		//console.debug("Genre : "+valeur_genre_recup) ;
		if(valeur_genre_recup!='non_selct') {
			nom_genre_recup = $('#selecteur_genre :selected').text() ;
			votre_selection+= "Genre : "+nom_genre_recup+"<br />";
		}
		else {
			//votre_selection+= "Aucun genre choisi<br />";
		}
		
		// TEXTE LIBRE
		valeur_txt_libre_recup = $("#chp_txt_libre").val();
		//console.debug("Genre : "+valeur_txt_libre_recup) ;
		if(valeur_txt_libre_recup!='') {
			votre_selection+= "Texte libre : "+valeur_txt_libre_recup+"<br />";
		}
		else {
			//votre_selection+= "Aucun texte libre choisi<br />";
		}
		
		
		// AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
		// Afficher le message "Votre sélection) :
		// AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
		$("#montrer_selection").append("<strong>Votre s&eacute;tection</strong><br />"+votre_selection+"");
		$("#montrer_selection").fadeIn("slow");



		// ---------------------------------------------


		// ---------------------------------------------
		// Requête AJAX
		// ---------------------------------------------
		$.post("agenda/moteur_2_2/requete_utf8/requete.php", {
		lieu: ""+valeur_lieu_recup+"", 
		region: ""+valeur_region_recup+"",
		genre: ""+valeur_genre_recup+"",
		chaine_txt_libre: ""+valeur_txt_libre_recup+"",
		date_in: ""+selecteur_date_in+"",
		date_out: ""+selecteur_date_out+""
		}, function(data){
			var response_se = eval("(" + data + ")");
			//console.log(response_se.variable_test);
			//console.log(response_se.nombre_resultats);
			//console.log(response_se.preview_event);

			// Nombre de résultats
			// ---------------------------------
			$('#nbre_resultats_id').fadeIn(300);
			if(response_se.nombre_resultats>0) {
				$('#nbre_resultats_id').html(response_se.nombre_resultats+" evenement(s)");
			}
			else {
				$('#nbre_resultats_id').html("Aucun résultat");
			}


			// Liste prévisualisation
			// ---------------------------------
			if(response_se.nombre_resultats>0) {
			
			
				$('#event_preview_id').fadeTo(100, 0.1, function () {
				
					$('#event_preview_id').html(response_se.preview_event+" ");
					$('#event_preview_id').slideDown(200);
					$('#event_preview_id').fadeTo(100, 1);
				
				});
			  
			  
			
			}


			
			
		
			
			// Afficher liste de proposition de titres quand des valeurs de retour AJAX existent 
			// ------------------------------------------------------------------------------------
			if(response_se.dlp_list_events.length != 0) {
				var response_se = eval("(" + data + ")");
	
				$('#autoSuggestionsList').html(response_se.dlp_list_events);

				// Effets de déroulement de la liste des suggestions
				$('#suggestions').slideDown(400);
				$('#suggestions').fadeTo(100, 1);
				
			}
			
		},"json");



	/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */		
	}
	/* ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++ */


	
	/* Sélecteur de DATE IN
	********************* */
	// Loader l'UI Datepicker
	$("#selecteur_date_in").datepicker();
	/* CModification des paramètres (Attention à la sybntaxe ! http://www.nabble.com/Syntax-confusion-td19960925s27240.html) */
	$("#selecteur_date_in").datepicker("change", {dateFormat: "dd-mm-yy"});
	$("#selecteur_date_in").datepicker("change", {dayNamesMin: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa']});
	$("#selecteur_date_in").datepicker("change", {monthNames: ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre']});
	$("#selecteur_date_in").datepicker("change", {monthNamesShort: ['Janv','Fév','Mars','Avril','Mai','Juin','Juillet','Août','Sept','Oct','Nov','Déc']});
	$("#selecteur_date_in").datepicker("change", {changeMonth: true});
	$("#selecteur_date_in").datepicker("change", {changeYear: true});
	$("#selecteur_date_in").datepicker("change", {yearRange: '2007:2011'});	


	// Imposer une date de DEBUT > à date de FIN
	$("#selecteur_date_in").change(function () {
		date_in = $("#selecteur_date_in").val();

		day_debut = date_in.substring(0,2);
		month_debut = (date_in.substring(3,5))-1;
		year_debut = date_in.substring(6,10);
		//alert ('d= '+day_debut+ ' m= '+month_debut+ ' y= '+year_debut) ;
		date_to_out = new Date();
		date_to_out.setDate(day_debut);
		date_to_out.setMonth(month_debut);
		date_to_out.setFullYear(year_debut);
		
		$("#selecteur_date_out").datepicker("change", {minDate: date_to_out});

		// Appel PHP
		appel_php() ;
	});
	

	
	/* Sélecteur de DATE OUT
	********************* */
	// Loader l'UI Datepicker
	$("#selecteur_date_out").datepicker();
	/* CModification des paramètres (Attention à la sybntaxe ! http://www.nabble.com/Syntax-confusion-td19960925s27240.html) */
	$("#selecteur_date_out").datepicker("change", {dateFormat: "dd-mm-yy"});
	$("#selecteur_date_out").datepicker("change", {dayNamesMin: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa']});
	$("#selecteur_date_out").datepicker("change", {monthNames: ['Janvier','Février','Mars','Avril','Mai','Juin','Juillet','Août','Septembre','Octobre','Novembre','Décembre']});
	$("#selecteur_date_out").datepicker("change", {monthNamesShort: ['Janv','Fév','Mars','Avril','Mai','Juin','Juillet','Août','Sept','Oct','Nov','Déc']});
	$("#selecteur_date_out").datepicker("change", {changeMonth: true});
	$("#selecteur_date_out").datepicker("change", {changeYear: true});
	$("#selecteur_date_out").datepicker("change", {yearRange: '2007:2011'});

	$("#selecteur_date_out").change(function () {
		
		// Imposer une date de DEBUT < à date de FIN		
		date_out = $("#selecteur_date_out").val();


		day_debut = date_out.substring(0,2);
		month_debut = (date_out.substring(3,5))-1;
		year_debut = date_out.substring(6,10);
		//alert ('d= '+day_debut+ ' m= '+month_debut+ ' y= '+year_debut) ;
		date_to_in = new Date();
		date_to_in.setDate(day_debut);
		date_to_in.setMonth(month_debut);
		date_to_in.setFullYear(year_debut);
		
		$("#selecteur_date_in").datepicker("change", {maxDate: date_to_in});
		
		// Appel PHP
		appel_php() ;
	});




	
	/* Sélecteur de LIEU
	********************* */
	$("#selecteur_lieu").change(function() {
		valeur_lieu = $(this).val();
		  /*if (valeur_lieu != 0) {
			 // console.debug(valeur_lieu) ;
			  appel_php() ;
		  }*/
		appel_php() ;
	});
	
	
	/* Sélecteur de REGION
	********************* */
	$("#selecteur_region").change(function() {
		valeur_region = $(this).val();
		appel_php() ;
	});
	
	
	/* Sélecteur de GENRE
	********************* */
	$("#selecteur_genre").change(function() {
		valeur_genre = $(this).val();
		appel_php() ;
	});
	
	
	
	/* TEST CHP LIBRE
	********************* */
	$("#chp_txt_libre").keyup(function() {
		chaine_txt_libre = $(this).val();

		// Effets d'effacement de la liste des suggestions
		$('#suggestions').fadeTo(1,0.4);
		$('#suggestions').slideUp(300);

		
		// setTimeout = retarder une action
		setTimeout(function attendre_un_peu() {
			appel_php() ;
		}, 300);
		
		
	});



		
	/* Champ texte libre
	********************* */
	$("#chp_txt_libre").keyup(function lookup(valeur_chp_txt_libre) {
	valeur_chp_txt_libre = $(this).val();
	//console.log("Lookup = "+valeur_chp_txt_libre);
	if(valeur_chp_txt_libre.length == 0) {
		// Hide the suggestion box.
		$('#suggestions').fadeOut(1000);
	} else {
		
		}
	}) // # fct lookup

	
	/* RAZ du formulaire
	********************* */
	$("#effacer_tous_champs").click(function() {
		//console.log("reset form");
		document.forms["form_moteur_dlp_ajax"].reset(); // Cette instruction n'écrase pas les variables, d'où la suite...
		$("#selecteur_lieu").val('');
		$("#selecteur_region").val('');
		$("#selecteur_genre").val('');
		$("#chp_txt_libre").val('');
		/*$("#selecteur_date_in").val('');
		$("#selecteur_date_out").val('');*/
		
		appel_php() ;

	});

	

});

function fill(thisValue) {
	$("input[name='chp_txt_libre']").val(thisValue)
	setTimeout("$('#suggestions').hide();", 200);
	//alert(thisValue);
}	





</script>


</head>
<body>
<div id="header">
</div>
<INCLURE{fond=inc_tur/agmenu}{id_rubrique}>

<div id="principal">
	<div class="colonne1">
		[<h2>(#TITRE|supprimer_numero)</h2>]

<?php
	if (! isset($GLOBALS['spip_connect_version'])) {
		include_once('ecrire/base/connect_sql.php');
		require('config/connect.php');
	}
	if ((int)'[(#ENV{id_rubrique}|texte_script)]' == 143)
		include('agenda/moteur_2_2/moteur.php');
		//echo 'yyyyyy' ;

	else
		echo ' Le numéro de rubrique ne convient pas. ';
?>
	
	



	</div><!-- fin colonne1 -->
	<div class="colonne2">
		<INCLURE{fond=inc_tur/recherche_rapide}>
		<INCLURE{fond=inc_tur/outils_spectateurs}>
		

	</div>
	<div class="clear"></div>
</div>
<div id="footer">
	<INCLURE{fond=inc_tur/footer}>
</div>
</body>
</html>
</BOUCLE_princ>
